---
import Layout from '@layouts/Common.astro'

import ImageCard from '@components/ImageCard.astro'

import {fetchNewsletters} from '@queries/newsletter'

import type {Info} from '@interfaces/info'
import type {Section} from '@interfaces/section'
import type {Seo} from '@interfaces/seo'
import type {Social} from '@interfaces/social'

interface Props {
  info: Info
  content: Section[]
  seo: Seo
  social: Social
}

import {fetchPage} from '@queries/page'

const newsletterPage = await fetchPage('newsletters')
const {info, content, seo, social} = newsletterPage

const newsletters = await fetchNewsletters()

// Sort newsletters by week in descending order (most recent first)
const sortedNewsletters = newsletters.sort((a, b) => {
  const dateA = a.info.week ? new Date(a.info.week).getTime() : 0
  const dateB = b.info.week ? new Date(b.info.week).getTime() : 0
  return dateB - dateA
})

export const prerender = true
---

<Layout {info} {seo}>
  <div class="content py-content-block">
    <div class="flex flex-wrap justify-center gap-6">
      {
        sortedNewsletters.map(newsletter => {
          const {info} = newsletter
          const formattedDate = info.week
            ? new Date(info.week).toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                timeZone: 'UTC'
              })
            : 'Untitled Newsletter'

          return (
            <ImageCard
              title={formattedDate}
              image={info.images?.[0]}
              href={`/newsletters/${info.slug.current}`}
            />
          )
        })
      }
    </div>
  </div>
</Layout>

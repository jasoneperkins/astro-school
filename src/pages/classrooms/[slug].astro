---
import Layout from '@layouts/Common.astro'
import ContactForm from '@components/ContactForm.astro'
import ImageCard from '@components/ImageCard.astro'
import Testimonials from '@content/testimonials.astro'

import {PortableText} from 'astro-portabletext'
import {fetchClassroom, fetchClassrooms} from '@queries/classroom'

import type {Classroom} from '@interfaces/classroom'
import type {Seo} from '@interfaces/seo'
import type {Social} from '@interfaces/social'

interface Props {
  info: Classroom['info']
  content: Classroom['content']
  seo: Seo
  social: Social
}

export async function getStaticPaths() {
  const classrooms = await fetchClassrooms()

  return classrooms.map(({info}) => ({
    params: {slug: info.slug.current},
    props: {slug: info.slug.current}
  }))
}

const {slug} = Astro.params
const {info, content, seo, social} = await fetchClassroom(slug)

const allClassrooms = await fetchClassrooms()
const otherClassrooms = allClassrooms
  .filter(c => c.info.slug.current !== slug)
  .sort((a, b) => (a.info.age || 0) - (b.info.age || 0))

export const prerender = true
---

<Layout {info} {content} {seo} {social}>
  {
    content?.map(section => {
      if (section.name === 'testimonials') {
        return <Testimonials {...section} />
      }
      return (
        <section class="content grid-cols-content-100">
          <div class="half">
            <PortableText value={section.body as any} />
          </div>
          <div class="half">
            <article class="rounded-lg bg-blue-800 p-10">
              <ContactForm theme="dark" btnColor="teal" initialMode="tour" />
            </article>
          </div>
        </section>
      )
    })
  }

  <section class="content py-content-block pt-0!">
    <header>
      <hgroup>
        <h2>More Classrooms</h2>
      </hgroup>
    </header>
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
      {
        otherClassrooms.map(classroom => (
          <ImageCard
            title={classroom.info.title}
            image={classroom.info.images?.[0]}
            href={`/classrooms/${classroom.info.slug.current}`}
            cta="Explore Our Classroom"
          />
        ))
      }
    </div>
  </section>
</Layout>

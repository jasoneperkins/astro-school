---
import {SEO} from 'astro-seo'
import {urlFor} from '@services/sanity'
import {ClientRouter} from 'astro:transitions'

import type {Info} from '@interfaces/info'
import type {Identity} from '@interfaces/identity'
import type {Seo} from '@interfaces/seo'
import type {Social} from '@interfaces/social'
import type {CustomImage} from '@interfaces/customImage'

interface Props {
  info: Info
  identity: Identity
  seo: Seo
  social?: Social
}

const {href} = Astro.url
const {info, identity, seo, social} = Astro.props

const {title, slug, images, author} = info
const {name: siteName} = identity
const {
  metaTitle,
  metaDescription,
  canonicalUrl,
  noIndex = false,
  noFollow = false
} = seo || {}
const {
  shareTitle,
  shareDescription,
  shareImage,
  twitterTitle,
  twitterDescription,
  twitterImage,
  twitterCardType = 'summary_large_image'
} = social || {}

const displayTitle = metaTitle || title || siteName
const titleTemplate = slug?.current === 'index' ? undefined : `%s | ${siteName}`

const displayDescription = metaDescription || ''

const ogTitle = shareTitle || displayTitle
const ogDescription = shareDescription || displayDescription
const twTitle = twitterTitle || ogTitle
const twDescription = twitterDescription || ogDescription

const getImgUrl = (image?: CustomImage, width = 1200, height = 630) =>
  image ? urlFor(image).width(width).height(height).url() : undefined

// Priority: Specific Social Image -> Page Main Image -> Default Site Image
const pageMainImage = images?.[0]
const ogImageUrl =
  getImgUrl(shareImage, 1200, 630) ||
  getImgUrl(pageMainImage, 1200, 630) ||
  '/default-og.jpg'
const twImageUrl = getImgUrl(twitterImage, 1200, 600) || ogImageUrl

const isLive = import.meta.env.PROD // Only respect noIndex in production
---

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <SEO
    title={displayTitle}
    titleTemplate={titleTemplate}
    description={displayDescription}
    canonical={canonicalUrl || href}
    noindex={noIndex || !isLive}
    nofollow={noFollow || !isLive}
    openGraph={{
      basic: {
        title: ogTitle,
        type: 'website', // You could map schemaType here if you wanted dynamic types
        image: ogImageUrl
      },
      optional: {
        description: ogDescription,
        siteName: siteName
      },
      image: {
        alt: ogTitle
      }
    }}
    twitter={{
      card: twitterCardType,
      site: '@yourtwitterhandle', // Optional: Add to Identity schema if needed
      creator: author,
      title: twTitle,
      description: twDescription,
      image: twImageUrl,
      imageAlt: twTitle
    }}
  />

  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  <link rel="manifest" href="/site.webmanifest" />
  <meta name="theme-color" content="#fafafa" />
  <meta name="generator" content={Astro.generator} />

  {
    pageMainImage && (
      <link
        rel="preload"
        as="image"
        href={urlFor(pageMainImage).width(1200).url()}
      />
    )
  }

  <ClientRouter />
</head>

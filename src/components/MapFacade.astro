---
interface Props {
  address: string;
  name: string;
  width?: string;
  height?: string;
}

const { address, name, width = "100%", height = "150" } = Astro.props;
const mapUrl = `https://maps.google.com/maps?q=${encodeURIComponent(address)}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
---

<div
  class="map-facade-container relative overflow-hidden bg-gray-200"
  style={`width: ${width}; height: ${height}px;`}
  data-address={address}
  data-name={name}
  data-url={mapUrl}
>
  <div class="flex h-full w-full items-center justify-center text-gray-500">
    <div class="flex flex-col items-center gap-2">
      <div class="size-6 animate-pulse rounded-full bg-gray-300"></div>
      <span class="text-xs uppercase tracking-widest">Loading Map...</span>
    </div>
  </div>
</div>

<script>
  import { loadOnVisibility } from "@logic/observer";

  const containers = document.querySelectorAll(".map-facade-container");

  containers.forEach((container) => {
    if (container instanceof HTMLElement) {
      loadOnVisibility(container, () => {
        const url = container.dataset.url;
        const name = container.dataset.name;
        
        if (url) {
          const iframe = document.createElement("iframe");
          iframe.src = url;
          iframe.title = `Map showing location of ${name}`;
          iframe.width = "100%";
          iframe.height = container.style.height.replace("px", "");
          iframe.style.border = "0";
          iframe.allowFullscreen = true;
          iframe.loading = "lazy";
          iframe.referrerPolicy = "no-referrer-when-downgrade";
          
          container.innerHTML = "";
          container.appendChild(iframe);
        }
      });
    }
  });
</script>
